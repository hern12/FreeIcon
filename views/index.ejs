<!DOCTYPE html>
<html lang="en">
<head>
    <% include ./head %>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
</head>
<body>
	<div class="container-fluid bg">
	    <div ng-app="FreeIcon">
	    	<h1 class="HeadText">แจก Icon ฟรี!!</h1>
	    	<div ng-controller = "IconsController" class=""> <!--ng-init ="listIcon()"--> 
	    		<center>
	    		<div class="form-group">
				    <form>
                       <input type="text" class="search" ng-init ="listIcon()"ng-model="post.PostId" placeholder="Search..." required>
                       <span class="arrow">
                       <input type="button"class="button" ng-click="listIcon(post.PostId);" value="Search">
                   	   </span>
		            </form>
				</div>
				</center>
	   			<ul class = "item-list row col-centered col-md-offset-0">
					<li ng-repeat="t in imgUrl" class="col-md-2 list">
						<a href="#" class="img-block" onclick="showImageInModal(this);" data-toggle="modal" data-target="#myModal">
							<img ng-src="{{t}}" alt="img01"class="img-center" onerror="imgError(this);" >
							<!-- <button class="btn btn-primary button-center">DOWNLOAD</button> -->
						</a>
					</li>
				</ul>
				<center><div class="loader"></div></center>
				<!-- Modal -->
				<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
				  <div class="modal-dialog" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				        <h4 class="modal-title" id="myModalLabel">Modal title</h4>
				      </div>
				      <div class="modal-body showImg">
				        <img class="mdImg"src="">
				      </div>
				      <div class="modal-footer">
				        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				        <button type="button" class="btn btn-primary">Save changes</button>
				      </div>
				    </div>
				  </div>
				</div>
	    	</div>
	    </div>
	 </div><!-- container -->
</body>
<script type="text/javascript" src="./javascripts/angular.js"></script>
<script>
	var app = angular.module("FreeIcon",[]);
	app.controller("IconsController",function($scope,$http){
		$scope.title = "Hello Webboard";
		$scope.Topics = [];
		$scope.imgUrl = [];
		$scope.Name = [];
		var numberIcon = 1;
		var countShow = 1;
		var checkText = "";
		$(".loader").hide();
		$scope.listIcon = function(searchText){
			countShow = 1;
			$scope.imgUrl = [];
			checkText = searchText;
			if(checkText == null ||checkText == undefined){
				checkText ="search";
			}
			$(".loader").show();
			var url = "https://api.iconfinder.com/v2/icons/search?query="+checkText+"&count=100&premium=0";
			$http.get(url).success(function(data){
			//console.log(searchText);
			placeData(data);
			var totalCount = $scope.Topics.total_count;
			
			var caculateTotalrang = Math.floor(totalCount/100);
			$(window).scroll(function(e) {
					if(numberIcon <= caculateTotalrang){
					    if($(window).scrollTop() >= $(document).height() - $(window).height()) {
					    	  $(".loader").show();
					          countShow = countShow +100;
					          console.log(countShow);			  
					          var url = "https://api.iconfinder.com/v2/icons/search?query="+checkText+"&count=100&premium=0&offset=";
					          url += ""+countShow;
					          //console.log(url);
					          $http.get(url).success(function(data){
								placeData(data);
							  }).error(function(error, status){
							  	console.log("Error"+error);
							  	console.log("Error"+status);
							  });
							  numberIcon++;
					    }
					}
				e.preventDefault();
			})
			if($scope.Topics.total_count == 0){
				alert("ไม่มี Icon ที่คุณตามหา");
			}

			}).error(function(data){
				location.reload();
			})
		}

		function placeData(data){
			$scope.Topics = data;
			for(var i = 0;i<$scope.Topics.icons.length;i++){
				for(var j = 0;j<$scope.Topics.icons[i].raster_sizes.length;j++){
					var rasterSize = $scope.Topics.icons[i].raster_sizes[j].size_width;
					var previewuUrl = $scope.Topics.icons[i].raster_sizes[j].formats[0].preview_url;
					if(previewuUrl){
						if(rasterSize === 512){
							$scope.imgUrl.push(previewuUrl);
							break;
						}
						if(rasterSize === 256){
							$scope.imgUrl.push(previewuUrl);
							break;
						}
						if(rasterSize === 128){
							$scope.imgUrl.push(previewuUrl);
							break;
						}
					}
				}
			}
			$(".loader").hide();
		}
	})
	function imgError(image){
	 	// image.parent().remove();
	 	 event.stopPropagation();
    	 $(image).parent().parent().hide();
	}
	function showImageInModal(imageLink){
		var getImg = $(imageLink).children().attr("ng-src");
		$(".mdImg").attr("src",""+getImg+"");
	}
</script>
<script type="text/javascript">
	(function($) {
    var $window = $(window),
        $col = $('ul');
        console.log($window );
    function resize() {
        if ($window.width() <= 1280) {
        	$col.removeClass('col-md-offset-0');
            return $col.addClass('col-md-offset-1');
        }else{
        	$col.removeClass('col-md-offset-1');
            return $col.addClass('col-md-offset-0');
        }
    }
    $window
        .resize(resize)
        .trigger('resize');
})(jQuery);

</script>
</html>